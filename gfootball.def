Bootstrap: docker
From: python:3.9-bullseye

%files
    football /opt/football
    GRF_MARL/requirements.txt /opt/requirements.txt

%post
    unset CC CXX
    export CC=/usr/bin/gcc
    export CXX=/usr/bin/g++
    export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    
    export DEBIAN_FRONTEND=noninteractive
    apt-get update && apt-get install -y \
        git cmake build-essential libgl1-mesa-dev libsdl2-dev \
        libsdl2-image-dev libsdl2-ttf-dev libsdl2-gfx-dev libboost-all-dev \
        libdirectfb-dev libst-dev mesa-utils xvfb x11vnc \
        gcc g++

    pip install "setuptools==65.5.0" "wheel==0.38.4" psutil
    
    # PyTorch with CUDA 11.8 support (compatible with H100 GPUs)
    pip install torch==2.0.1+cu118 torchvision==0.15.2+cu118 torchaudio==2.0.2 \
        --extra-index-url https://download.pytorch.org/whl/cu118

    pip install "gym==0.21.0"

    # Pin NumPy to 1.x for compatibility
    pip install "numpy<2"

    # Install GFootball from local copy
    cd /opt/football
    export CMAKE_BUILD_PARALLEL_LEVEL=1
    export MAKEFLAGS='-j1'
    pip install .

    # Install GRF_MARL dependencies (code will be bind mounted at runtime)
    pip install -r /opt/requirements.txt

    apt-get clean
    rm -rf /var/lib/apt/lists/*

%environment
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export CC=/usr/bin/gcc
    export CXX=/usr/bin/g++

%runscript
    exec python "$@"